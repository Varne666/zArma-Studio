#!/bin/bash
ROOT="/home/arma/Desktop/zArma Studio"

# Kill existing
pkill -9 -u "$USER" -f "node .*server\.js" 2>/dev/null || true
pkill -9 -u "$USER" -f "vite" 2>/dev/null || true

for p in 3000 3001 5173; do
  PID="$(lsof -tiTCP:$p -sTCP:LISTEN 2>/dev/null || true)"
  [ -n "$PID" ] && kill -9 $PID 2>/dev/null || true
done

sleep 1

# Backend 3001
echo "ğŸ“¡ Starting Backend..."
cd "$ROOT/app/backend" && PORT=3001 node server.js &
BACKEND_PID=$!

# Wait for backend
echo "â³ Waiting for backend..."
for i in $(seq 1 30); do
  curl -fsS "http://127.0.0.1:3001/api/ollama-status" >/dev/null 2>&1 && { echo "âœ… Backend ready"; break; }
  sleep 0.5
done

# Frontend 3000
echo "ğŸ¨ Starting Frontend..."
cd "$ROOT/app" && npm run dev -- --host &
FRONTEND_PID=$!

sleep 4
xdg-open "http://localhost:3000"
echo "ğŸŒ Opening browser..."
echo "Backend PID: $BACKEND_PID"
echo "Frontend PID: $FRONTEND_PID"
